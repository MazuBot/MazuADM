#!/usr/bin/env python3
import os
import re
import sys

import httpx


def _env(name: str) -> str | None:
    value = os.environ.get(name)
    if value:
        return value
    return None


def _parse_target_args(argv: list[str]) -> tuple[str, int, str]:
    if len(argv) < 4:
        raise RuntimeError("missing target args: <host> <port> <team_id>")
    host = argv[1]
    port = int(argv[2])
    team_id = argv[3]
    return host, port, team_id


def main() -> int:
    try:
        host = _env("TARGET_HOST")
        port = _env("TARGET_PORT")
        team_id = _env("TARGET_TEAM_ID")
        if host and port and team_id:
            host, port, team_id = host, int(port), team_id
        else:
            host, port, team_id = _parse_target_args(sys.argv)
    except Exception as exc:
        print(f"[!] {exc}", file=sys.stderr)
        print("usage: exploit.py <host> <port> <team_id>", file=sys.stderr)
        return 2

    base = f"http://{host}:{port}"

    try:
        with httpx.Client(timeout=5.0, follow_redirects=True) as client:
            resp = client.get(f"{base}/")
            resp.raise_for_status()
    except Exception as exc:
        print(f"[!] request failed: {exc}", file=sys.stderr)
        return 1

    text = resp.text.strip()
    match = re.search(r"FLAG\\{[^}]+\\}", text)
    if not match:
        print(text)
        return 3

    print(match.group(0))
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
